% mnras_template.tex
%
% LaTeX template for creating an MNRAS paper
%
% v3.0 released 14 May 2015
% (version numbers match those of mnras.cls)
%
% Copyright (C) Royal Astronomical Society 2015
% Authors:
% Keith T. Smith (Royal Astronomical Society)

% Change log
%
% v3.0 May 2015
%    Renamed to match the new package name
%    Version number matches mnras.cls
%    A few minor tweaks to wording
% v1.0 September 2013
%    Beta testing only - never publicly released
%    First version: a simple (ish) template for creating an MNRAS paper

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Basic setup. Most papers should leave these options alone.
\documentclass[fleqn,usenatbib]{mnras}  % a4paper,

% MNRAS is set in Times font. If you don't have this installed (most LaTeX
% installations will be fine) or prefer the old Computer Modern fonts, comment
% out the following line
%\usepackage{newtxtext,newtxmath}
%\usepackage{lmodern}
% Depending on your LaTeX fonts installation, you might get better results with one of these:
\usepackage{mathptmx}
%\usepackage{txfonts}


% Use vector fonts, so it zooms properly in on-screen viewing software
% Don't change these lines unless you know what you are doing
\usepackage[T1]{fontenc}
\usepackage{ae,aecompl}
\usepackage{diagbox}

%%%%% AUTHORS - PLACE YOUR OWN PACKAGES HERE %%%%%

% Only include extra packages if you really need them. Common packages are:
\usepackage{graphicx}	% Including figure files
\usepackage{amsmath}	% Advanced maths commands
\usepackage{amssymb}	% Extra maths symbols
\usepackage{savesym}  % prevent symbol conflicts
\savesymbol{sf}
%\generate{%
%  \file{breqn.sty}{\nopreamble\from{breqn.dtx}{breqn.sty}}%
%}
%\usepackage{breqn} % automatic breaking equation 
%\usepackage{fancyvrb}
%\VerbatimFootnotes
\usepackage{cprotect}  % to allow verb in caption 
\DeclareMathOperator\erfc{erfc}
\DeclareMathOperator\erf{erf}
\DeclareMathOperator\cdf{cdf}
\DeclareMathOperator\sf{sf}
\DeclareMathOperator\isf{isf}
\DeclareMathOperator\ppf{ppf}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% AUTHORS - PLACE YOUR OWN COMMANDS HERE %%%%%

% Please keep new commands to a minimum, and use \newcommand not \def to avoid
% overwriting existing commands. Example:
%\newcommand{\pcm}{\,cm$^{-2}$}	% per cm-squared

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%% TITLE PAGE %%%%%%%%%%%%%%%%%%%

% Title of the paper, and the short title which is used in the headers.
% Keep the title short and informative.
\title[DRW fitting]{Using C\'el\'erit\'e to infer DRW parameters }

% The list of authors, and the short list which is used in the headers.
% If you need two or more lines of authors, add an extra line using \newauthor
\author[K. Suberlak et al.]{
Krzysztof Suberlak,$^{1}$\thanks{E-mail: suberlak@uw.edu}
\v{Z}eljko Ivezi\'c $^{1}$
\\
% List of institutions
$^{1}$Department of Astronomy, University of Washington, Seattle, WA, United States\\
}

% These dates will be filled out by the publisher
\date{Accepted XXX. Received YYY; in original form ZZZ}

% Enter the current year, for the copyright statements etc.
\pubyear{2017}

% Don't change these lines
\begin{document}
\label{firstpage}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}
\maketitle

% Abstract of the paper
\begin{abstract}
A report to outline validation of C\'el\'erit\'e. We compare the tools used to fitting for $\tau$ and $SF_{\infty}$ to those of \cite{kozlowski2017a}and \cite{macleod2011}. To do so we reproduce some of experiments they conducted, and evaluate whether they can be mutually consistent. 
\end{abstract}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% BODY OF PAPER %%%%%%%%%%%%%%%%%%

\section{Introduction}
\label{sec:1}

Quasars exhibit stochastic variability with characteristic timescales of hundreds of days (Kelly+2009,  Kozlowski+2010,2016, 2017 Macleod+2010,2011,2012, Zu+2011,2013,2016, Kasliwal+2015,2017 ). We employ  C\'el\'erit\'e \citep{foreman2017} , which allows to express any one -dimensional process as a Gaussian Process.  Gaussian Process is defined by covariance and mean. Covariance parameters are often called hyperparameters. To find best-fit hyperparameters we optimize the marginal likelihood  (eq. 5.4, 5.8, Rassmussen\&Williams book). Since the marginal likelihood is the integral of  the product of likelihood and prior,  the logarithm of marginalized likelihood is the sum of the log-likelihood and log-prior (eq.2.28 Rassmussen\&Williams). 

In this report we summarize the tests that have been made to establish great usefulness of  C\'el\'erit\'e in modelling the DRW light curves as Gaussian Processes. We  first compare whether algorithms used to make mock DRW light curves are identical between MacLeod +2011 (which we use), and \cite{kozlowski2017a} (who challenges Macleod+2011 results, and whose results we reproduce). Then we describe how  a choice of boundaries and priors affects the results of best-fit hyperparameters with  C\'el\'erit\'e.  We then compare C\'el\'erit\'e  to another well-tested tool (used by \cite{kozlowski2016a}, \cite{zu2011}, etc.) - JAVELIN.  We then reproduce results of \cite{macleod2011} Fig.15, and \cite{kozlowski2017a} Fig.2 .  	We aim to answer the following questions: 
\begin{enumerate}
\item are the tools for fitting tau and SFinf equivalent?
\item can we reproduce Chelsea`s Fig 15?
\item can we reproduce Kozlowski`s plot? 
\item are their plots mutually consistent, given our analysis? 
\item can we reproduce best-fit tau and SFinf obtained using light curve
     fitting with the SF approach? 
\end{enumerate}




\section{Simulating DRW}

We simulate damped random walk light curves by drawing  points from a Gaussian distribution, for which mean and standard deviation are re-calculated at each timestep. Given an input of observation times $t$,   $SF_{\infty}$ - the asymptotic value of the structure function, mean magnitude  $\langle y \rangle$, and the damping timescale $\tau$, we start at time $t_{0}$ and signal at that time is equal to the mean$y_{0} = \langle y \rangle$. The timestep is   
$\Delta t_{i} = t_{i+1} - t_{i}$.  Given  the signal at time $t_{i}$: $y_{i}$,  and $\Delta t_{i}$,  the signal at next time step $y_{i+1}$ is drawn from  $\mathcal{N}(loc, stdev)$, where : 

\begin{equation}
loc = y_{i} e ^ { - r  }  + \langle y \rangle \left( 1 - e ^{ - r }\right)
\end{equation}

and 

\begin{equation}
stdev^{2} =  0.5  \, \mathrm{SF}_{\infty}^{2} \left( 1 - e ^{  - 2 r  }  \right)
\end{equation}

with  $r = \Delta t_{i} / \tau$.   Here we followed eq. A4 and A5 in \cite{kelly2009}, as well as Sec. 2.2 in \cite{macleod2010}.  To this ideal light curve signal we add photometric noise $\mathcal{N}(0,n_{i})$, where $n_{i}$ is the observational photometric noise.  It is equivalent to  Kozlowski+2017 formulation , who also starts with the signal $s_{i}$ , drawing at each time step light curve points from  a Gaussian distribution with dispersion  $stdev$ and mean $loc$, subsequently adding the mean $\langle y \rangle$ and Gaussian noise (see Eq. (2) of \cite{kozlowski2017a}).


Apart from $\tau$ and $SF_{\infty}$, we choose $N_{pts}$ - at how many points to sample the simulated DRW process, and the length of baseline $T = l \cdot \tau$.  In this formalism the baseline multiplicity $l$  is equivalent to $1 / \rho$ where  $\rho = \tau / T $  (Kozlowski+2017). We can sample the baseline either at regular intervals of $\Delta t$, or at random $N_{pts}$. One sets the other - given  $\Delta t$,  we find $N_{pts}$ as the nearest integer to $t_{max} - t_{min} / \Delta t $. 


\section{DRW as Gaussian Process}
DRW is a stochastic process defined by the covariance matrix  

\begin{equation}
S_{ij} = \sigma^{2} \exp{ \left(   -  \Delta t_{ij} / \tau \right)}
\end{equation}
( see Kozlowski+2010 eq. 1, Kozlowski+2017 eq. 1,  MacLeod+2011 eq.1, Zu+2013 eq. 3 , etc ).  A scatter of magnitude difference plotted as a function of time lag $\Delta t_{ij} $ is called the Structure Function (SF).  SF for the Damped Random Walk is described by  :

\begin{equation}
SF(\Delta t_{ij} ) = SF_{\infty} \left( 1 - e^{-|\Delta t_{ij} /\tau|} \right) ^{1/2}
\end{equation}

For large $\Delta t_{ij} $ , we have    
\[ \lim_{\Delta t_{ij} \gg \tau} e^{-|\Delta t_{ij} /\tau| }= 1 \]
so that: \[   SF(\Delta t_{ij} \to \infty)\xrightarrow[]{} SF_{\infty} \].  Following MacLeod+2011,  we define the driving amplitude for shot-term variability as :

\begin{equation}
\hat{\sigma} = \sigma \sqrt{2 / \tau}
\end{equation} 

We can relate $SF_{\infty}$ to $\sigma$ and $\hat{\sigma}$ : 

\begin{equation}
SF_{\infty} = \hat{\sigma} \sqrt{\tau} = \sigma \sqrt{2}
\end{equation} 

thus $SF_{\infty}$ is just a scaled version of $\sigma$. 

Another often used combination of hyperparameters is called $K$ (as in MacLeod+2011) : 

\begin{equation}
K = \tau \sqrt{SF_{\infty} }= \tau \sqrt{\sigma} 2^{1/4} 
\end{equation}.  

In the $\log{\sigma}$ - $\log{\tau}$ space, lines of constant $K$ or $\hat{\sigma}$ are perpendicular to each other.  This is because, if we take $\log{\hat{\sigma}}$, and rearrange, we have  : 

\begin{equation}
\log{\sigma} = \frac{1}{2} \log{\tau} + \log{\hat{\sigma}} - \frac{1}{2} \log{2}
\label{eq:sigma_hat_line}
\end{equation}

and from  $\log{K}$ : 

\begin{equation}
\log{\sigma} = -2 \log{\tau} + \log{K} - \frac{1}{2} \log{2}
\label{eq:K_line}
\end{equation}

These equations denote lines $y = ax + b$,  and the slope of one is the  inverse reciprocal of another, which proves that they are orthogonal in that space (see Fig.~\ref{fig:lc_logL_arrows})

Covariance matrix, or kernel, is a function that defines similarity between two points. In general, a kernel is any function that maps $x$, $x'$ onto $\mathbb{R}$. Thus a covariance function is a specific type of a kernel.   A Gaussian process is defined by its covariance function and mean. To model light curves as DRW using Gaussian Process approach we use the Real Term kernel in Celerite : 

\begin{equation}
S_{ij} = a_{j} e^ {-c_{j} | t_{j} - t_{i}|}
\end{equation}

with parameters  \verb|log_a| and \verb|log_c|.    It is clear that this is a DRW kernel if we substitute  $a_{j} \equiv \sigma^{2}$, and  $c_{j} \equiv \tau^{-1}$, so that $\verb|log_a| = 2 \log \sigma$, and $\verb|log_c| = - \log \tau$.  By default there are no boundaries on parameter values, and there is no prior.  We find that imposing very liberal boundaries does not affect the result of fit but helps ensure computational stability. Thus we choose to limit $\sigma$ to between 0.01 and 1.0 mag, and $\tau$ to between 1 and 10000 days . 
Both \cite{macleod2011}  and \cite{kozlowski2017a} use Jeffreys prior \citep{jeffreys46} on $\tau$ and $\hat{\sigma}$ : $prior(\tau) = 1 / \tau$ ,  and $prior(\hat{\sigma}) = 1 / \hat{\sigma}$.  Jeffreys prior  can be effectively expressed in terms of  \verb|a| and \verb|c| parameters :  

\begin{equation}
prior(\verb|a|,\verb|c|) = c + \frac{1}{\sqrt{2 ac}} 
\end{equation}

so that in logarithmic space : 

\begin{equation}
\log{(prior)} = \frac{1}{2} \left( \verb|log_c| - \verb|log_a|- \log{2} \right)
\end{equation}


\section{Likelihood for GP}
Celerite efficiently evaluates the marginalized likelihood of the dataset under a Gaussian Process model with given kernel and hyperparameters. We optimize the  log-likelihood  for the best-fit hyperparameters with the stable   L-BFGS-B  \citep{lu1995}, \citep{zhu1997}  algorithm   using  \verb|scipy.optimize.minimize| \citep{jones2001} implementation.  We illustrate the shape of log-likelihood for a simulated light curve with parametes  {$\tau_{in}=100$ days, $\sigma_{in} = 0.2^{\mathrm{mag}}$, Gaussian noise of $0.001^{\mathrm{mag}}$, with length $20 \tau$, and regular sampling of $\Delta t = 1 $ day  }, and flat prior . See   Fig. ~\ref{fig:lc_logL_fit}  for the light curve and GP prediction, and Fig.~\ref{fig:lc_logL} for the the shape of log-likelihood evaluated for this data on the grid of hyperparameters $\sigma$, $\tau$. 

\begin{figure}
\includegraphics[width=1.05\columnwidth]{figs/sim_lc_flat_prior_fit.png}
%\vskip -0.15in
\caption{A Celerite fit to a simulated light curve using a flat prior. }
\label{fig:lc_logL_fit}
\end{figure} 

\begin{figure}
\includegraphics[width=1.05\columnwidth]{figs/sim_lc_loglike.png}
%\vskip -0.15in
\caption{The log likelihood for the simulated light curve on Fig.~\ref{fig:lc_logL_fit}. Black contours show 0.683, 0.955, 0.997 levels of the cumulative (integrated) posterior probability. }
\label{fig:lc_logL}
\end{figure} 





\begin{figure*}
\includegraphics[width=1.05\textwidth]{figs/sim_lc_logL_four_panels.png}
%\vskip -0.15in
\caption{For each pixel on the  $\sigma$ - $\tau$ grid we evaluated the log-likelihood value, $\log{L}$, shown on the bottom-right panel (same as Fig.~\ref{fig:lc_logL}). In addition, given these  $\sigma$ and $\tau$ we also evaluated $K$ and $\hat{\sigma}$, which enabled, given $\{ \sigma, \tau, \hat{\sigma}, K, \log{L} \}$, plotting $\log{L}$ in space of $K$-$\hat{\sigma}$, or any other parameter as a function of the other two. }
\label{fig:lc_logL_panels}
\end{figure*} 

\begin{figure}
\includegraphics[width=1.05\columnwidth]{figs/sim_lc_log-log_K_sigma_hat_arrows.png}
%\vskip -0.15in
\caption{The log likelihood for the simulated light curve, plotted in  $\log{\sigma}$-$\log{\tau}$ space.  White gaps occur because originally the   $\sigma$ - $\tau$ grid on which we evaluated $\log{L}$ was linear, not logarithmic.  Black contours show 0.683, 0.955, 0.997 levels of the cumulative (integrated) posterior probability. Choosing the scale to be the same along both axes,  arrows that point along direction of constant $\hat{\sigma}$ or constant $K$ are perpendicular, as shown by Eqs.\ref{eq:sigma_hat_line} and \ref{eq:K_line}. }
\label{fig:lc_logL_arrows}
\end{figure} 


\section{Experimenting with number of points and baseline}
% or how we reproduced Macleod+2011 Fig. 15  : 


% the simulation setup  : the knobs and whistles 



% the original figure  : how we have the same behavior 


% two additional experiments : 


% 1)  changing the number of points  : weird stuff happens  : 
     % inspecting the Structure Function .... 


% 2) changing the baseline : exactly as expected 


\section{Experiments with damping timescale retrieval }
% or how we reproduce Kozlowski+17 Fig.2 : 

% exactly the same simulation setup  

% results, and how they depend on a combination of noise,  Npts, sampling....


\section{Conclusions}
% or,  have we answered the questions posed initially ?  



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%% REFERENCES %%%%%%%%%%%%%%%%%%

% The best way to enter references is to use BibTeX:

\bibliographystyle{mnras}
\bibliography{references} % if your bibtex file is called references.bib

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% Don't change these lines
\bsp	% typesetting comment
\label{lastpage}
\end{document}

% End of mnras_template.tex
